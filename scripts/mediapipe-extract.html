<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>MediaPipe Landmark Extractor</title>
</head>
<body>
  <canvas id="canvas" style="display:none"></canvas>
  <div id="status">Loading...</div>
  <script type="module">
    import { FilesetResolver, PoseLandmarker } from '/wasm-bundle/vision_bundle.mjs';

    let landmarker = null;

    async function init(modelUrl, wasmDir) {
      document.getElementById('status').textContent = 'Initializing...';
      const vision = await FilesetResolver.forVisionTasks(wasmDir);
      landmarker = await PoseLandmarker.createFromOptions(vision, {
        baseOptions: {
          modelAssetPath: modelUrl,
          delegate: 'CPU',
        },
        runningMode: 'IMAGE',
        numPoses: 1,
        minPoseDetectionConfidence: 0.5,
        minPosePresenceConfidence: 0.5,
        minTrackingConfidence: 0.5,
      });
      document.getElementById('status').textContent = 'Ready';
      return true;
    }

    async function detectFromDataUrl(dataUrl) {
      if (!landmarker) throw new Error('Not initialized');

      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          try {
            const canvas = document.getElementById('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);

            const result = landmarker.detect(canvas);

            if (!result.landmarks || result.landmarks.length === 0) {
              resolve({
                success: false,
                error: 'No pose detected',
                frameWidth: img.naturalWidth,
                frameHeight: img.naturalHeight,
              });
              return;
            }

            const landmarks = result.landmarks[0].map(lm => ({
              x: lm.x,
              y: lm.y,
              z: lm.z,
              visibility: lm.visibility ?? 0,
            }));

            const worldLandmarks = result.worldLandmarks[0].map(lm => ({
              x: lm.x,
              y: lm.y,
              z: lm.z,
              visibility: lm.visibility ?? 0,
            }));

            resolve({
              success: true,
              landmarks,
              worldLandmarks,
              frameWidth: img.naturalWidth,
              frameHeight: img.naturalHeight,
            });
          } catch (err) {
            reject(err);
          }
        };
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = dataUrl;
      });
    }

    // Expose functions to Playwright
    window.__mediapipe = { init, detectFromDataUrl };
  </script>
</body>
</html>
